<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Frontend Qualifica√ß√£o</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Teste Frontend Qualifica√ß√£o</h2>
        
        <!-- Checklist de Teste -->
        <div class="card">
            <div class="card-header">
                <h5>Checklist de Qualifica√ß√£o Registral</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60%">Item</th>
                                <th class="text-center">SIM</th>
                                <th class="text-center">N√ÉO</th>
                                <th class="text-center">N/A</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    1) H√° outro protocolo mais antigo vinculado √†(s) matr√≠cula(s) objeto do presente contrato?<br>
                                    <small class="text-muted">OBS: Verificar os avisos de matr√≠cula.</small>
                                </td>
                                <td class="text-center"><input type="radio" name="item1" id="item1_sim" disabled /></td>
                                <td class="text-center"><input type="radio" name="item1" id="item1_nao" disabled /></td>
                                <td class="text-center"><input type="radio" name="item1" id="item1_na" disabled /></td>
                            </tr>
                            <tr>
                                <td>
                                    2) Tratando-se de reingresso, conferir se todas as pend√™ncias foram sanadas, e se toda documenta√ß√£o foi reapresentada.
                                </td>
                                <td class="text-center"><input type="radio" name="item2" id="item2_sim" disabled /></td>
                                <td class="text-center"><input type="radio" name="item2" id="item2_nao" disabled /></td>
                                <td class="text-center"><input type="radio" name="item2" id="item2_na" disabled /></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Bot√µes de Teste -->
        <div class="mt-3">
            <button class="btn btn-primary" onclick="testarPreenchimento()">Testar Preenchimento</button>
            <button class="btn btn-success" onclick="testarJustificativas()">Testar Justificativas</button>
        </div>
        
        <!-- Log -->
        <div class="mt-3">
            <h6>Log de Teste:</h6>
            <div id="log" class="border p-3 bg-light" style="height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <div class="container mt-5">
        <h2>Valida√ß√£o Jur√≠dica e Nota Devolutiva (Teste)</h2>
        <div class="card mb-3">
            <div class="card-header">1. Envie os documentos para Valida√ß√£o Jur√≠dica</div>
            <div class="card-body">
                <input type="file" id="fileInputValidacao" multiple accept=".pdf" class="form-control mb-2" />
                <button class="btn btn-primary" id="btnValidarJuridico" disabled>Validar Jur√≠dico</button>
                <div id="validacaoStatus" class="mt-2"></div>
            </div>
        </div>
        <div class="card mb-3">
            <div class="card-header">2. Resultado da Valida√ß√£o Jur√≠dica</div>
            <div class="card-body">
                <div id="painelValidacao"></div>
                <button class="btn btn-danger mt-3 d-none" id="btnGerarNota">Gerar Nota Devolutiva</button>
            </div>
        </div>
        <div class="card mb-3">
            <div class="card-header">3. Nota Devolutiva Gerada</div>
            <div class="card-body">
                <div id="painelNotaDevolutiva"></div>
                <button class="btn btn-outline-secondary mt-2 d-none" id="btnExportarWord">Exportar Word</button>
                <button class="btn btn-outline-secondary mt-2 d-none" id="btnExportarPDF">Exportar PDF</button>
            </div>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function testarPreenchimento() {
            log('üß™ Testando preenchimento dos radio buttons...');
            
            // Simular dados da IA
            const dadosTeste = {
                campos: {
                    'item1_protocolo_antigo': 'N/A',
                    'item2_reingresso_pendencias': 'Sim',
                    'justificativa_item1': 'N√£o h√° men√ß√£o a protocolo antigo nas matr√≠culas analisadas.',
                    'justificativa_item2': 'H√° refer√™ncia a reingresso nos documentos.'
                }
            };
            
            // Testar mapeamento
            const checklistMapping = {
                'item1_protocolo_antigo': 'item1',
                'item2_reingresso_pendencias': 'item2'
            };
            
            Object.entries(checklistMapping).forEach(([backendField, itemName]) => {
                const value = dadosTeste.campos[backendField] || 'N/A';
                log(`üîç Processando ${backendField}: ${value}`);
                
                // Encontrar o radio button correto
                let radioButton = null;
                if (value === 'Sim') {
                    radioButton = document.getElementById(`${itemName}_sim`);
                } else if (value === 'N√£o') {
                    radioButton = document.getElementById(`${itemName}_nao`);
                } else if (value === 'N/A') {
                    radioButton = document.getElementById(`${itemName}_na`);
                }
                
                if (radioButton) {
                    radioButton.checked = true;
                    log(`‚úÖ ${backendField}: ${value} - Radio button marcado`);
                } else {
                    log(`‚ùå Radio button n√£o encontrado: ${itemName}_${value.toLowerCase()}`);
                }
            });
        }
        
        function testarJustificativas() {
            log('üß™ Testando adi√ß√£o de justificativas...');
            
            // Testar fun√ß√£o addJustificativaToItem
            addJustificativaToItem('item1', 'Teste de justificativa em vermelho');
            addJustificativaToItem('item2', 'Outra justificativa de teste');
            
            log('‚úÖ Justificativas adicionadas');
        }
        
        function addJustificativaToItem(itemName, justificativa) {
            const row = document.querySelector(`input[name="${itemName}"]`).closest('tr');
            if (row) {
                // Remover justificativa existente se houver
                const existingJustificativa = row.querySelector('.justificativa-text');
                if (existingJustificativa) {
                    existingJustificativa.remove();
                }
                
                // Adicionar nova justificativa
                const justificativaCell = document.createElement('td');
                justificativaCell.colSpan = 4;
                justificativaCell.className = 'justificativa-cell';
                justificativaCell.innerHTML = `<div class="justificativa-text" style="color: red; font-size: 0.9em; padding: 5px; background-color: #fff5f5; border-left: 3px solid #dc3545;"><strong>Justificativa:</strong> ${justificativa}</div>`;
                
                // Adicionar ap√≥s a linha atual
                const newRow = document.createElement('tr');
                newRow.appendChild(justificativaCell);
                row.parentNode.insertBefore(newRow, row.nextSibling);
                
                log(`üìù Justificativa adicionada para ${itemName}: ${justificativa}`);
            }
        }
        
        // Inicializar
        log('üöÄ Teste inicializado');
    </script>

    <script>
// Estado
let validacaoResultado = null;
let notaDevolutivaResultado = null;

const fileInput = document.getElementById('fileInputValidacao');
const btnValidar = document.getElementById('btnValidarJuridico');
const statusDiv = document.getElementById('validacaoStatus');
const painelValidacao = document.getElementById('painelValidacao');
const btnGerarNota = document.getElementById('btnGerarNota');
const painelNota = document.getElementById('painelNotaDevolutiva');
const btnExportarWord = document.getElementById('btnExportarWord');
const btnExportarPDF = document.getElementById('btnExportarPDF');

fileInput.addEventListener('change', () => {
    btnValidar.disabled = fileInput.files.length === 0;
    statusDiv.innerHTML = '';
    painelValidacao.innerHTML = '';
    painelNota.innerHTML = '';
    btnGerarNota.classList.add('d-none');
    btnExportarWord.classList.add('d-none');
    btnExportarPDF.classList.add('d-none');
});

btnValidar.addEventListener('click', async () => {
    if (fileInput.files.length === 0) return;
    statusDiv.innerHTML = '<span class="text-info">Processando...</span>';
    painelValidacao.innerHTML = '';
    painelNota.innerHTML = '';
    btnGerarNota.classList.add('d-none');
    btnExportarWord.classList.add('d-none');
    btnExportarPDF.classList.add('d-none');

    const formData = new FormData();
    Array.from(fileInput.files).forEach(f => formData.append('files[]', f));
    const response = await fetch('/api/validacao-juridica', { method: 'POST', body: formData });
    const data = await response.json();
    if (data.success) {
        validacaoResultado = data.validacao;
        statusDiv.innerHTML = '<span class="text-success">Valida√ß√£o conclu√≠da!</span>';
        renderPainelValidacao(validacaoResultado);
        // Se houver problemas cr√≠ticos, mostrar bot√£o de nota
        if (validacaoResultado && validacaoResultado.resumo_validacao && validacaoResultado.resumo_validacao.problemas_criticos && validacaoResultado.resumo_validacao.problemas_criticos.length > 0) {
            btnGerarNota.classList.remove('d-none');
        }
    } else {
        statusDiv.innerHTML = '<span class="text-danger">Erro: ' + (data.error || 'Falha na valida√ß√£o') + '</span>';
    }
});

btnGerarNota.addEventListener('click', async () => {
    if (!validacaoResultado) return;
    painelNota.innerHTML = '<span class="text-info">Gerando nota devolutiva...</span>';
    btnExportarWord.classList.add('d-none');
    btnExportarPDF.classList.add('d-none');
    const response = await fetch('/api/nota-devolutiva', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ validacao: validacaoResultado })
    });
    const data = await response.json();
    if (data.success) {
        notaDevolutivaResultado = data.nota_devolutiva;
        renderPainelNota(notaDevolutivaResultado);
        btnExportarWord.classList.remove('d-none');
        btnExportarPDF.classList.remove('d-none');
    } else {
        painelNota.innerHTML = '<span class="text-danger">Erro: ' + (data.error || 'Falha ao gerar nota') + '</span>';
    }
});

btnExportarWord.addEventListener('click', () => {
    if (!notaDevolutivaResultado) return;
    const blob = new Blob([notaDevolutivaResultado.texto_completo || JSON.stringify(notaDevolutivaResultado, null, 2)], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'nota_devolutiva.doc';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

btnExportarPDF.addEventListener('click', () => {
    if (!notaDevolutivaResultado) return;
    const doc = new window.jspdf.jsPDF();
    const content = notaDevolutivaResultado.texto_completo || JSON.stringify(notaDevolutivaResultado, null, 2);
    const lines = doc.splitTextToSize(content, 180);
    doc.text(lines, 10, 10);
    doc.save('nota_devolutiva.pdf');
});

function renderPainelValidacao(validacao) {
    if (!validacao) return;
    let html = '';
    if (validacao.validacao_documentos) {
        html += '<h6>Valida√ß√£o dos Documentos</h6>';
        html += '<table class="table table-bordered table-sm"><thead><tr><th>Documento</th><th>Status</th><th>Observa√ß√µes</th></tr></thead><tbody>';
        for (const [doc, info] of Object.entries(validacao.validacao_documentos)) {
            html += `<tr><td>${doc}</td><td>${info.status || ''}</td><td>${info.observacoes || ''}`;
            if (info.problemas && info.problemas.length > 0) {
                html += '<ul>' + info.problemas.map(p => `<li>${p}</li>`).join('') + '</ul>';
            }
            html += '</td></tr>';
        }
        html += '</tbody></table>';
    }
    if (validacao.validacao_checklist) {
        html += '<h6>Checklist Registral</h6>';
        html += '<table class="table table-bordered table-sm"><thead><tr><th>Item</th><th>Status</th><th>Observa√ß√£o</th></tr></thead><tbody>';
        for (const [item, info] of Object.entries(validacao.validacao_checklist)) {
            html += `<tr><td>${item}</td><td>${info.status || ''}</td><td>${info.observacao || ''}</td></tr>`;
        }
        html += '</tbody></table>';
    }
    if (validacao.resumo_validacao) {
        html += '<h6>Resumo Geral</h6>';
        html += `<div><strong>Status:</strong> ${validacao.resumo_validacao.status_geral || ''}</div>`;
        if (validacao.resumo_validacao.problemas_criticos && validacao.resumo_validacao.problemas_criticos.length > 0) {
            html += `<div class="text-danger"><strong>Problemas Cr√≠ticos:</strong> ${validacao.resumo_validacao.problemas_criticos.join(', ')}</div>`;
        }
        if (validacao.resumo_validacao.recomendacoes && validacao.resumo_validacao.recomendacoes.length > 0) {
            html += `<div><strong>Recomenda√ß√µes:</strong> ${validacao.resumo_validacao.recomendacoes.join(', ')}</div>`;
        }
    }
    painelValidacao.innerHTML = html;
}

function renderPainelNota(nota) {
    if (!nota) return;
    let html = '';
    if (nota.texto_completo) {
        html += `<pre style="white-space: pre-wrap; background: #f8f9fa; border: 1px solid #ddd; padding: 10px;">${nota.texto_completo}</pre>`;
    } else {
        html += `<pre>${JSON.stringify(nota, null, 2)}</pre>`;
    }
    painelNota.innerHTML = html;
}
</script>
</body>
</html> 